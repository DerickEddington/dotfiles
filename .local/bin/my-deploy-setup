#! /usr/bin/env bash
set -o errexit -o nounset
shopt -s assoc_expand_once extglob
(( "${VERBOSE:=0}" >= 3 )) && set -o xtrace
(( "${VERBOSE:=0}" >= 4 )) && set -o verbose


# Capture arguments, before anything else could mess with them.
#
readonly selfFull=$0
readonly args=("$@")


# shellcheck source=../share/my/bash/helpers.bash
source "${XDG_DATA_HOME:-$HOME/.local/share}"/my/bash/helpers.bash


self=$(std basename "$selfFull"); readonly self

if (( ${#args[@]} != 1 )); then
    std cat 1>&2 <<-EOF
	Usage: $self ssh://[USER@]HOSTNAME[:PORT]
	   or: $self vagrant://[NAME|ID]
	   or: $self dir:LOCALDIR
	EOF
    exit 1
fi


# Defaults

readonly defaultDotfilesRepo=$HOME/.dotfiles
readonly defaultDotfilesRefs='HEAD main'


# Functions

function process-vars
{
    process-args
    process-env-vars

    readonly baseDirOfNeededByBootstrap="${MY_DATA_HOME:?}"/my
    readonly dirsNeededByBootstrap=(sh bash deploy-setup)
    readonly prefixNeededByBootstrap=.local/share/my
}

function process-args
{
    targetUrl="${args[0]}"
    # shellcheck disable=SC2016
    targetHomeDirExpr='"${HOME:?}"'

    if [[ "$targetUrl" =~ ^dir:(.*)$ ]]; then
        targetLocalDir=${BASH_REMATCH[1]}
        if [ "$targetLocalDir" ]; then
            targetLocalDir=$(gnu realpath -m -L -s "$targetLocalDir") || return
            if ! [ -e "$targetLocalDir" ]; then
                std mkdir -p "$targetLocalDir" || return
            fi
            if [ -d "$targetLocalDir" ] \
            && [ -r "$targetLocalDir" ] && [ -w "$targetLocalDir" ] && [ -x "$targetLocalDir" ]
            then
                targetHomeDirExpr=$(quote "$targetLocalDir")
                targetUrl=shell://localhost
            else
                error "Invalid directory: $(quote "$targetLocalDir")" 2
            fi
        else
            error "Missing directory name in URL: $(quote "$targetUrl")!" 3
        fi
    fi

    readonly targetUrl targetHomeDirExpr
}

function process-env-vars
{
    localDotfilesRepo=${MY_DEPLOY_SETUP_DOTFILES_FROM_REPO:-$defaultDotfilesRepo}
    if ! [[ "$localDotfilesRepo" = */@(.git|.dotfiles) ]]; then
        localDotfilesRepo+=/.git
    fi
    localDotfilesRepo=$(gnu realpath -m -L -s "$localDotfilesRepo") || return

    [ -r "$localDotfilesRepo" ] || error "Invalid dotfiles repo: $(quote "$localDotfilesRepo")" 4

    bundleRefs=${MY_DEPLOY_SETUP_DOTFILES_FROM_REFS:-$defaultDotfilesRefs}
    split-on-words "$bundleRefs" bundleRefs

    primaryDotfilesBranch=${bundleRefs[0]}  # The first ref is considered the primary.

    readonly localDotfilesRepo bundleRefs primaryDotfilesBranch
}

function rsh { rsh-cd . "$@" ;}

function rsh-cd {
    local shOpts=('set -e;')
    (( VERBOSE >= 3 )) && shOpts+=('set -x;')
    (( VERBOSE >= 4 )) && shOpts+=('set -v;')

    remote-sh-cd "$targetUrl" "$1" "${shOpts[*]} $2" "${@:3}"
}

function rsh-in-bd { rsh-cd "$targetBootstrapDir" "$@" ;}

function check-can-command-target
{
    # Basic sanity check before the looping in `make-bootstrap-dir`.
    #
    rsh 'true' || error "Cannot execute a simple shell command in the target host!" 5
}

function make-bootstrap-dir
{
    local attempts=5
    while (( attempts-- >= 1 )); do
        # (Use `mktemp` in the local host, because it might not be available in a remote host.)
        targetBootstrapDir=$(gnu mktemp -u XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX)

        # shellcheck disable=SC2016
        if targetBootstrapDir=$(rsh '
                                    tmpDir=${TMPDIR:-/tmp}
                                    bootstrapDir=$tmpDir/'"$(quote "$targetBootstrapDir")"'

                                    if mkdir -m u=rwx,g=,o= "$bootstrapDir" ; then
                                        printf "%s" "$bootstrapDir"
                                    else
                                        exit 1
                                    fi
                                ')
        then
            break
        else
            unset targetBootstrapDir
        fi
    done
    readonly targetBootstrapDir

    [ "${targetBootstrapDir:-}" ] || fail "Failed to make bootstrap directory in target host!" 6
}

function copy-bootstrap-scripts
{
    local - ; set -o pipefail

    make-bootstrap-dir

    gnu tar --create --directory="$baseDirOfNeededByBootstrap" --dereference \
        --transform="s,^,$prefixNeededByBootstrap/," \
        "${dirsNeededByBootstrap[@]}" \
    | \
    rsh-in-bd 'tar xf -'  # (Any `tar` implementation, not only GNU's, should work this way.)
}

function copy-dotfiles-bundle
{
    local - ; set -o pipefail

    # As bundle is created, immediately output it over the connection to the target host without
    # having an intermediate local file.
    #
    git --git-dir="$localDotfilesRepo" bundle create - "${bundleRefs[@]}" \
    | \
    rsh-in-bd 'cat > ./dotfiles.git.bundle'
}

function copy-bootstrap-files
{
    copy-bootstrap-scripts
    copy-dotfiles-bundle
}

function run-bootstrap
{
    rsh-in-bd "
        HOME=$targetHomeDirExpr         \
        VERBOSE=$(quote "$VERBOSE")     \
            ./.local/share/my/deploy-setup/bootstrap/start0.sh $(quote "$primaryDotfilesBranch")
    "
}


# Operations

process-vars
check-can-command-target
copy-bootstrap-files
run-bootstrap
